'use client';

import { useState, useRef, useEffect } from 'react';

interface VoiceInterviewProps {
    position: string;
    level: string;
    cvId: string;
    onComplete: (transcript: { question: string; answer: string }[]) => void;
    onCancel: () => void;
}

export default function VoiceInterview({ 
    position, 
    level, 
    cvId, 
    onComplete, 
    onCancel 
}: VoiceInterviewProps) {
    const [isListening, setIsListening] = useState(false);
    const [currentQuestion, setCurrentQuestion] = useState('');
    const [currentAnswer, setCurrentAnswer] = useState('');
    const [transcript, setTranscript] = useState<{ question: string; answer: string }[]>([]);
    const [questionIndex, setQuestionIndex] = useState(0);
    const [isProcessing, setIsProcessing] = useState(false);
    const [isSpeaking, setIsSpeaking] = useState(false);
    
    const recognitionRef = useRef<any>(null);
    const synthRef = useRef<SpeechSynthesis | null>(null);
    const [voicesLoaded, setVoicesLoaded] = useState(false);

    // Web Speech API - Speech Recognition
    useEffect(() => {
        if (typeof window !== 'undefined') {
            // Speech Synthesis - s…ôsl…ôri y√ºkl…ô
            synthRef.current = window.speechSynthesis;
            
            // S…ôsl…ôrin y√ºkl…ônm…ôsini g√∂zl…ô
            const loadVoices = () => {
                const voices = synthRef.current?.getVoices() || [];
                if (voices.length > 0) {
                    setVoicesLoaded(true);
                    console.log('üîä Available voices:', voices.length);
                    console.log('üó£Ô∏è Azerbaijani voices (az-Latn-AZ):', voices.filter(v => v.lang === 'az-Latn-AZ').map(v => v.name));
                    console.log('üó£Ô∏è Azerbaijani voices (az-AZ):', voices.filter(v => v.lang === 'az-AZ').map(v => v.name));
                    console.log('üó£Ô∏è All Azerbaijani voices:', voices.filter(v => v.lang.startsWith('az')).map(v => `${v.name} (${v.lang})`));
                    console.log('üó£Ô∏è Turkish voices:', voices.filter(v => v.lang === 'tr-TR').map(v => v.name));
                }
            };

            // S…ôsl…ôr asenkron y√ºkl…ôn…ô bil…ôr
            if (synthRef.current) {
                loadVoices();
                synthRef.current.onvoiceschanged = loadVoices;
            }

            const SpeechRecognition = (window as any).SpeechRecognition || (window as any).webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                recognitionRef.current = new SpeechRecognition();
                recognitionRef.current.continuous = true;
                recognitionRef.current.interimResults = true;
                recognitionRef.current.lang = 'az-Latn-AZ'; // Az…ôrbaycan dili (Latin …ôlifbasƒ±)

                recognitionRef.current.onresult = (event: any) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        setCurrentAnswer(prev => prev + finalTranscript);
                    }
                };

                recognitionRef.current.onerror = (event: any) => {
                    console.error('Speech recognition error:', event.error);
                    setIsListening(false);
                };

                recognitionRef.current.onend = () => {
                    if (isListening) {
                        recognitionRef.current.start(); // Restart if should be listening
                    }
                };
            }
        }

        return () => {
            if (recognitionRef.current) {
                recognitionRef.current.stop();
            }
            if (synthRef.current) {
                synthRef.current.cancel();
            }
        };
    }, [isListening]);

    // ƒ∞lk sualƒ± al v…ô oxu
    useEffect(() => {
        if (questionIndex === 0 && voicesLoaded) {
            fetchAndSpeakQuestion();
        }
    }, [voicesLoaded]);

    // Sualƒ± Gemini-d…ôn al v…ô s…ôsl…ô oxu
    const fetchAndSpeakQuestion = async () => {
        setIsProcessing(true);
        try {
            const token = localStorage.getItem('accessToken');
            
            const response = await fetch('/api/mock-interview/voice/question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({
                    cvId,
                    position,
                    level,
                    questionIndex,
                    previousQA: transcript,
                }),
            });

            const data = await response.json();
            
            if (data.success && data.question) {
                setCurrentQuestion(data.question);
                speakText(data.question);
            }
        } catch (error) {
            console.error('Sual alƒ±nark…ôn x…ôta:', error);
        } finally {
            setIsProcessing(false);
        }
    };

    // M…ôtni s…ôsl…ô oxu (TTS)
    const speakText = (text: string) => {
        if (!synthRef.current || !voicesLoaded) {
            console.warn('‚ö†Ô∏è Speech synthesis not ready');
            return;
        }

        synthRef.current.cancel(); // ∆èvv…ôlki danƒ±≈üƒ±ƒüƒ± dayandƒ±r

        const utterance = new SpeechSynthesisUtterance(text);
        
        // M√∂vcud s…ôsl…ôri al
        const voices = synthRef.current.getVoices();
        console.log('üîä Total voices available:', voices.length);
        
        // B√ºt√ºn m√∂vcud s…ôsl…ôri g√∂st…ôr
        voices.forEach((voice, index) => {
            console.log(`  ${index + 1}. ${voice.name} (${voice.lang}) - ${voice.localService ? 'Local' : 'Remote'}`);
        });
        
        // Az…ôrbaycan dili s…ôsini tap (az-Latn-AZ prioritet, sonra az-AZ, sonra az)
        let selectedVoice = voices.find(voice => 
            voice.lang === 'az-Latn-AZ'
        );
        
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang === 'az-AZ'
            );
        }
        
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.toLowerCase().startsWith('az')
            );
        }
        
        console.log('üó£Ô∏è Azerbaijani voice:', selectedVoice?.name || 'Not found');
        
        // ∆èg…ôr Az…ôrbaycan dili yoxdursa, T√ºrk dilini (tr-TR, tr) istifad…ô et
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.toLowerCase().startsWith('tr')
            );
            console.log('üó£Ô∏è Fallback to Turkish voice:', selectedVoice?.name || 'Not found');
        }
        
        // Rus dilini sƒ±na (b…ôzi hallar √º√ß√ºn)
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.toLowerCase().startsWith('ru')
            );
            console.log('üó£Ô∏è Fallback to Russian voice:', selectedVoice?.name || 'Not found');
        }
        
        // ∆èg…ôr he√ß biri yoxdursa, ingilis dilind…ô qadƒ±n s…ôsi
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.toLowerCase().startsWith('en') && 
                (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('woman'))
            );
            console.log('üó£Ô∏è Fallback to English female voice:', selectedVoice?.name || 'Not found');
        }
        
        // ∆èn yax≈üƒ± s…ôsi se√ß (ist…ônil…ôn ingilis)
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => 
                voice.lang.toLowerCase().startsWith('en')
            );
            console.log('üó£Ô∏è Fallback to any English voice:', selectedVoice?.name || 'Not found');
        }
        
        // He√ß bir ≈üey tapƒ±lmadƒ±sa, ilk m√∂vcud s…ôsi g√∂t√ºr
        if (!selectedVoice && voices.length > 0) {
            selectedVoice = voices[0];
            console.log('üó£Ô∏è Fallback to first available voice:', selectedVoice.name);
        }
        
        if (selectedVoice) {
            utterance.voice = selectedVoice;
            utterance.lang = selectedVoice.lang; // S…ôsin dilin…ô uyƒüunla≈üdƒ±r
            console.log('‚úÖ Selected voice:', selectedVoice.name, '(' + selectedVoice.lang + ')');
        } else {
            console.error('‚ùå No voices available!');
            utterance.lang = 'tr-TR'; // Ehtiyat dil
        }
        
        utterance.rate = 0.85; // Danƒ±≈üƒ±q s√ºr…ôti (0.1-10) - bir az yava≈ü aydƒ±nlƒ±q √º√ß√ºn
        utterance.pitch = 1.0; // S…ôs tonu (0-2)
        utterance.volume = 1.0; // S…ôs h…ôcmi (0-1)

        utterance.onstart = () => {
            setIsSpeaking(true);
            console.log('üé§ Started speaking:', text.substring(0, 50) + '...');
        };
        
        utterance.onend = () => {
            setIsSpeaking(false);
            console.log('‚úîÔ∏è Finished speaking');
            // Sual oxunandan sonra dinl…ôm…ôy…ô ba≈üla
            startListening();
        };
        
        utterance.onerror = (event) => {
            console.error('‚ùå Speech synthesis error:', event.error, event);
            setIsSpeaking(false);
            // Error olsa da dinl…ôm…ôy…ô ba≈üla
            startListening();
        };

        console.log('üîä Speaking with settings:', {
            voice: utterance.voice?.name,
            lang: utterance.lang,
            rate: utterance.rate,
            pitch: utterance.pitch,
            volume: utterance.volume
        });

        synthRef.current.speak(utterance);
    };

    // Mikrofonu ba≈ülat
    const startListening = () => {
        if (recognitionRef.current && !isListening) {
            setCurrentAnswer('');
            recognitionRef.current.start();
            setIsListening(true);
        }
    };

    // Mikrofonu dayandƒ±r
    const stopListening = () => {
        if (recognitionRef.current && isListening) {
            recognitionRef.current.stop();
            setIsListening(false);
        }
    };

    // Cavabƒ± t…ôsdiql…ô v…ô n√∂vb…ôti suala ke√ß
    const submitAnswer = async () => {
        if (!currentAnswer.trim()) {
            alert('Z…ôhm…ôt olmasa cavab verin');
            return;
        }

        stopListening();

        // Transkripta …ôlav…ô et
        const newTranscript = [...transcript, { question: currentQuestion, answer: currentAnswer }];
        setTranscript(newTranscript);

        // ∆èg…ôr 5 sual tamamdƒ±rsa
        if (questionIndex >= 4) {
            onComplete(newTranscript);
        } else {
            // N√∂vb…ôti sual
            setQuestionIndex(questionIndex + 1);
            setCurrentAnswer('');
            fetchAndSpeakQuestion();
        }
    };

    // S…ôsli m√ºsahib…ôni l…ôƒüv et
    const handleCancel = () => {
        stopListening();
        if (synthRef.current) {
            synthRef.current.cancel();
        }
        onCancel();
    };

    return (
        <div className="bg-white rounded-2xl shadow-xl p-8">
            {/* Header */}
            <div className="text-center mb-8">
                <div className="text-6xl mb-4">üéôÔ∏è</div>
                <h2 className="text-3xl font-bold text-gray-900 mb-2">
                    S…ôsli M√ºsahib…ô
                </h2>
                <p className="text-gray-600">
                    Sual {questionIndex + 1} / 5
                </p>
            </div>

            {/* Progress Bar */}
            <div className="mb-8">
                <div className="w-full bg-gray-200 rounded-full h-3">
                    <div
                        className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all"
                        style={{ width: `${((questionIndex + 1) / 5) * 100}%` }}
                    ></div>
                </div>
            </div>

            {/* Current Question */}
            <div className="mb-8">
                <div className={`bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border-2 ${
                    isSpeaking ? 'border-blue-500 animate-pulse' : 'border-blue-200'
                }`}>
                    <div className="flex items-start">
                        <div className="text-4xl mr-4">
                            {isSpeaking ? 'üîä' : 'ü§ñ'}
                        </div>
                        <div className="flex-1">
                            <div className="text-sm text-gray-600 mb-2">
                                {isSpeaking ? 'AI oxuyur...' : 'AI M√ºsahib…ô√ßi:'}
                            </div>
                            <div className="text-xl font-medium text-gray-900">
                                {currentQuestion || 'Sual hazƒ±rlanƒ±r...'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Voice Input Status */}
            <div className="mb-8">
                <div className={`rounded-xl p-6 border-2 transition-all ${
                    isListening 
                        ? 'bg-red-50 border-red-500' 
                        : 'bg-gray-50 border-gray-200'
                }`}>
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center">
                            <div className={`w-4 h-4 rounded-full mr-3 ${
                                isListening ? 'bg-red-500 animate-pulse' : 'bg-gray-400'
                            }`}></div>
                            <span className="font-medium text-gray-900">
                                {isListening ? 'üé§ Dinl…ôyir…ôm...' : 'üîá Dinl…ôm…ô dayandƒ±rƒ±lƒ±b'}
                            </span>
                        </div>
                        
                        {!isSpeaking && (
                            <button
                                onClick={isListening ? stopListening : startListening}
                                className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                    isListening
                                        ? 'bg-red-600 text-white hover:bg-red-700'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }`}
                            >
                                {isListening ? '‚è∏Ô∏è Dayandƒ±r' : '‚ñ∂Ô∏è Ba≈ülat'}
                            </button>
                        )}
                    </div>

                    {/* Transcript */}
                    <div className="bg-white rounded-lg p-4 min-h-[100px] max-h-[200px] overflow-y-auto">
                        <div className="text-sm text-gray-600 mb-2">Sizin cavabƒ±nƒ±z:</div>
                        <div className="text-gray-900">
                            {currentAnswer || 'Cavabƒ±nƒ±zƒ± s…ôsl…ô deyin...'}
                        </div>
                    </div>
                </div>
            </div>

            {/* Action Buttons */}
            <div className="flex justify-between gap-4">
                <button
                    onClick={handleCancel}
                    className="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-all"
                >
                    ‚ùå L…ôƒüv et
                </button>

                <div className="flex gap-3">
                    {isListening && (
                        <button
                            onClick={stopListening}
                            className="px-6 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-all"
                        >
                            ‚è∏Ô∏è Dayandƒ±r
                        </button>
                    )}
                    
                    <button
                        onClick={submitAnswer}
                        disabled={!currentAnswer.trim() || isSpeaking || isProcessing}
                        className="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-medium hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {questionIndex >= 4 ? '‚úÖ Bitir' : '‚û°Ô∏è N√∂vb…ôti sual'}
                    </button>
                </div>
            </div>

            {/* Info */}
            <div className="mt-6 text-center text-sm text-gray-500">
                üí° S…ôsinizi yax≈üƒ± e≈üitm…ôk √º√ß√ºn sakit bir m√ºhit se√ßin
            </div>
        </div>
    );
}
